<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>SC THE ADVENTURE | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå (Realtime)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<style>
:root{--primary:#2563eb;--danger:#dc2626;--bg:#f1f5f9}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:var(--bg)}
header{background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;padding:20px 30px;font-size:24px;font-weight:700}
.container{padding:32px;max-width:1700px;margin:auto}
button,input,select,textarea{width:100%;padding:14px;border-radius:16px;border:1px solid #c7d2fe;font-size:14px}
button{background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;transition:.2s}
button:hover{transform:translateY(-2px)}
button.danger{background:var(--danger)}
.card{background:#fff;border-radius:28px;padding:30px;margin-bottom:30px;box-shadow:0 25px 50px rgba(0,0,0,.15)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:28px}
.table{width:100%;border-collapse:collapse;border-radius:26px;overflow:hidden}
th,td{padding:18px;border-bottom:1px solid #e5e7eb;vertical-align:top}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center}
.modal-box{background:#fff;width:96%;max-width:1500px;border-radius:36px;padding:44px;max-height:92vh;overflow:auto}
.section-title{font-size:18px;font-weight:700;margin-bottom:12px}
.badge{padding:6px 16px;border-radius:999px;font-size:12px;font-weight:700}
.NEW{background:#fee2e2;color:#991b1b}
.INPROGRESS{background:#fef3c7;color:#92400e}
.DONE{background:#dcfce7;color:#166534}
.confirm-box{background:#fff;border-radius:28px;padding:34px;max-width:420px;width:90%;text-align:center}
.confirm-actions{display:flex;gap:26px;margin-top:28px}
</style>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#f0f1f3;
  font-family:Segoe UI,Tahoma,sans-serif;
  color:#222
}

.page{
  max-width:1800px;
  margin:32px auto;
  background:#fff;
  padding:32px 36px;
  border-radius:16px
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  border-bottom:1px solid #d6d9de;
  padding-bottom:16px
}
.header-left h1{margin:0;font-size:28px}
.header-left h2{margin:4px 0 0;font-size:16px;color:#666}
.header-right{display:flex;gap:20px}

label{font-size:13px;font-weight:600;color:#555}
input,textarea{
  width:100%;
  padding:8px 10px;
  border:1px solid #d1d5db;
  border-radius:10px;
  font-size:13px
}

.card{
  margin-top:24px;
  background:#fafafa;
  padding:20px;
  border-radius:16px
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px
}
th{
  background:#2f2f2f;
  color:#fff;
  padding:10px
}
td{
  padding:8px;
  border-bottom:1px solid #e5e7eb;
  vertical-align:top
}

.sub-row td{
  background:#f9fafb;
  padding:12px
}
.sub-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px
}

.btn{
  padding:10px 22px;
  border-radius:12px;
  font-weight:600;
  border:none;
  cursor:pointer
}
.btn.add{background:#e6e8ec}
.btn-print{
  margin-left:16px;
  background:#111;
  color:#fff;
  padding:8px 16px;
  border-radius:10px
}

.actions{
  margin-top:32px;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:16px
}

.btn-del{
  background:#fee2e2;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  cursor:pointer
}

/* =========================
   ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏π‡∏õ (‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡πâ‡∏ß)
   ========================= */
.img-box{
  width:180px;
  height:180px;
  border:2px dashed #94a3b8;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  overflow:hidden;
  background:#fff;
}
.img-box img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.img-hint{
  font-size:13px;
  color:#64748b;
}

/* ========================= */

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  backdrop-filter:blur(3px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000
}
.modal-box{
  background:#fff;
  padding:24px;
  border-radius:16px;
  width:320px;
  text-align:center
}
.trash-big{
  font-size:48px;
  color:#dc2626;
  margin-bottom:8px
}

@media print{
  button,.btn-del,.btn-print{display:none!important}
}

</style>
</head>
<body>

<header>üöó SC THE ADVENTURE | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå (Realtime)</header>

<div class="container">
<div class="card">
<div class="grid">
<select id="vehicleSelect"></select>
<input id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° (‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå)">
<button onclick="openModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</button>
<button class="danger" onclick="confirmDeleteVehicle()">üóë ‡∏•‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>
</div>

<div class="card">
<table class="table">
<thead>
<tr>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏ñ</th><th>‡∏£‡∏∞‡∏ö‡∏ö</th><th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th><th>‡∏ú‡∏π‡πâ‡∏ã‡πà‡∏≠‡∏°</th><th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏•‡∏ö</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<div class="modal" id="modal">
<div class="modal-box">
<h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Ultra Detail)</h2>

<div class="card">
<div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ (Vehicle Identity)</div>
<div class="grid">
<input id="plate" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ">
<input id="brand" placeholder="‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠">
<input id="model" placeholder="‡∏£‡∏∏‡πà‡∏ô">
<input id="year" placeholder="‡∏õ‡∏µ‡∏£‡∏ñ">
<input id="vin" placeholder="VIN / Chassis No.">
<input id="engineNo" placeholder="Engine No.">
<input id="mileage" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°">
<input id="fuelType" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á">
<input id="usageType" placeholder="‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß / ‡∏Ç‡∏ô‡∏Ç‡∏≠‡∏á / ‡∏≠‡∏≠‡∏ü‡πÇ‡∏£‡∏î)">
</div>
</div>

<div class="card">
<div class="section-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° (Maintenance Detail)</div>
<div class="grid">
<input type="date" id="date">
<input id="system" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏° (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå / ‡πÄ‡∏ö‡∏£‡∏Å / ‡∏ä‡πà‡∏ß‡∏á‡∏•‡πà‡∏≤‡∏á / ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡∏Ø‡∏•‡∏Ø)">
<select id="jobType">
<option>PM - Preventive</option>
<option>CM - Corrective</option>
<option>Emergency</option>
<option>Accident</option>
</select>
<select id="priority">
<option>‡∏ï‡πà‡∏≥</option><option>‡∏Å‡∏•‡∏≤‡∏á</option><option>‡∏™‡∏π‡∏á</option><option>‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</option>
</select>
<select id="status">
<option class="NEW">NEW</option>
<option class="INPROGRESS">INPROGRESS</option>
<option class="DONE">DONE</option>
</select>
</div>
<textarea id="symptoms" placeholder="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢ (Symptoms) ‚Äî ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î"></textarea>
<textarea id="rootCause" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á (Root Cause Analysis)"></textarea>
<textarea id="diagnosis" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå / ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Diagnosis Process)"></textarea>
<textarea id="repairMethod" placeholder="‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° / ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Repair Method)"></textarea>
<textarea id="prevention" placeholder="‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏ã‡πâ‡∏≥ (Preventive Action)"></textarea>
<textarea id="testResult" placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏° (Test Result)"></textarea>
</div>

<div class="card">
<div class="section-title">‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>
<div class="grid">
<input id="technician" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á / ‡∏ú‡∏π‡πâ‡∏ã‡πà‡∏≠‡∏°">
<input id="supervisor" placeholder="‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô">
<input id="vendor" placeholder="‡∏≠‡∏π‡πà / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
<input id="partsList" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ , )">
<input id="partsCost" type="number" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏ö‡∏≤‡∏ó)">
<input id="laborCost" type="number" placeholder="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á (‡∏ö‡∏≤‡∏ó)">
<input id="otherCost" type="number" placeholder="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô (‡∏ö‡∏≤‡∏ó)">
<input id="downtime" placeholder="Downtime (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á/‡∏ß‡∏±‡∏ô)">
<input id="warranty" placeholder="‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°">
</div>
<textarea id="remark" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / ‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï"></textarea>
</div>

<div class="confirm-actions">
<button onclick="save()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<button class="danger" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>

</div>
</div>

<div class="modal" id="confirmModal">
<div class="confirm-box">
<h3 id="confirmText"></h3>
<div class="confirm-actions">
<button id="confirmYes">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
<button class="danger" onclick="closeConfirm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCowDEvUQpBmq7AwUGiC6IuGOudPhi_0kM",
  authDomain: "vehicle-maintenance-64890.firebaseapp.com",
  projectId: "vehicle-maintenance-64890"
};



let unsubscribe=null;
let pendingAction=null;

function loadVehicles(){
  db.collection("vehicles").onSnapshot(snap=>{
    vehicleSelect.innerHTML="";
    snap.forEach(doc=>{
      let o=document.createElement("option");
      o.value=doc.id;o.textContent=doc.id;
      vehicleSelect.appendChild(o);
    });
    if(vehicleSelect.value) loadRepairs(vehicleSelect.value);
  });
}

vehicleSelect.onchange=()=>loadRepairs(vehicleSelect.value);

function loadRepairs(v){
  if(unsubscribe) unsubscribe();
  unsubscribe=db.collection("vehicles").doc(v).collection("repairs").onSnapshot(snap=>{
    tbody.innerHTML="";
    snap.forEach(doc=>{
      let r=doc.data();
      let cost=(+r.partsCost||0)+(+r.laborCost||0)+(+r.otherCost||0);
      if(searchInput.value && !JSON.stringify(r).toLowerCase().includes(searchInput.value.toLowerCase())) return;
      tbody.innerHTML+=`<tr>
      <td>${r.date||""}</td><td>${v}</td><td>${r.system||""}</td>
      <td>${(r.symptoms||"").substring(0,60)}...</td>
      <td>${r.technician||""}</td>
      <td>${cost.toLocaleString()}</td>
      <td><span class="badge ${r.status||"NEW"}">${r.status||"NEW"}</span></td>
      <td><button class="danger" onclick="confirmDeleteRecord('${v}','${doc.id}')">‡∏•‡∏ö</button></td>
      </tr>`;
    });
  });
}

function openModal(){modal.style.display='flex'}
function closeModal(){modal.style.display='none'}

function confirmDeleteVehicle(){
  confirmText.innerText="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?";
  pendingAction=()=>db.collection("vehicles").doc(vehicleSelect.value).delete();
  confirmModal.style.display='flex';
}

function confirmDeleteRecord(v,id){
  confirmText.innerText="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?";
  pendingAction=()=>db.collection("vehicles").doc(v).collection("repairs").doc(id).delete();
  confirmModal.style.display='flex';
}

confirmYes.onclick=()=>{pendingAction();confirmModal.style.display='none'}
function closeConfirm(){confirmModal.style.display='none'}

function save(){
  let key = plate.value+" | "+brand.value+" "+model.value;
  let ref=db.collection("vehicles").doc(key);
  ref.set({created:new Date()},{merge:true});
  ref.collection("repairs").add({
    plate:plate.value,brand:brand.value,model:model.value,year:year.value,vin:vin.value,
    engineNo:engineNo.value,mileage:mileage.value,fuelType:fuelType.value,usageType:usageType.value,
    date:date.value,system:system.value,jobType:jobType.value,priority:priority.value,status:status.value,
    symptoms:symptoms.value,rootCause:rootCause.value,diagnosis:diagnosis.value,
    repairMethod:repairMethod.value,prevention:prevention.value,testResult:testResult.value,
    technician:technician.value,supervisor:supervisor.value,vendor:vendor.value,
    partsList:partsList.value,partsCost:partsCost.value,laborCost:laborCost.value,
    otherCost:otherCost.value,downtime:downtime.value,warranty:warranty.value,remark:remark.value,
    createdAt:new Date()
  });
  closeModal();
}

loadVehicles();
</script>

<script>
if("serviceWorker" in navigator){navigator.serviceWorker.register("sw.js");}
</script>


<!-- Firebase compat (FINAL FIX) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCowDEvUQpBmq7AwUGiC6IuGOudPhi_0kM",
    authDomain: "vehicle-maintenance-64890.firebaseapp.com",
    projectId: "vehicle-maintenance-64890",
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  window.db = firebase.firestore();
</script>


<script>
const monthInput=document.getElementById('monthPicker');
const tbody=document.getElementById('tbody');
let deleteTarget=null;

monthInput.addEventListener('change',loadMonth);

function addRow(){
  const i=tbody.children.length/2+1;
  const main=document.createElement('tr');
  main.innerHTML=`
    <td class="no">${i}</td>
    <td><textarea></textarea></td>
    <td>
      <div class="img-box" onclick="pickImage(this)">
        <span class="img-hint">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ</span>
        <input type="file" accept="image/*" hidden onchange="previewImage(this)">
      </div>
    </td>
    <td><input></td>
    <td><input type="number"></td>
    <td><input type="number"></td>
    <td><input type="number" class="buy" oninput="calc(this)"></td>
    <td><input type="number" class="price" oninput="calc(this)"></td>
    <td class="sum">0.00</td>
    <td><input></td>
    <td><button class="btn-del" onclick="askDelete(this)">üóë</button></td>
  `;

  const sub=document.createElement('tr');
  sub.className='sub-row';
  sub.innerHTML=`
    <td colspan="11">
      <div class="sub-grid">
        <div><label>‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label><textarea></textarea></div>
        <div><label>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label><textarea></textarea></div>
      </div>
    </td>
  `;
  tbody.append(main,sub);
  saveMonth();
}

function pickImage(box){
  box.querySelector('input[type=file]').click();
}

function previewImage(input){
  const file=input.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const box=input.closest('.img-box');
    box.innerHTML=`<img src="${reader.result}">`;
    box.appendChild(input);
    saveMonth();
  };
  reader.readAsDataURL(file);
}

function calc(el){
  const r=el.closest('tr');
  const q=r.querySelector('.buy').value||0;
  const p=r.querySelector('.price').value||0;
  r.querySelector('.sum').innerText=(q*p).toFixed(2);
  recalcGrand();
}

function recalcGrand(){
  let t=0;
  document.querySelectorAll('.sum').forEach(s=>t+=parseFloat(s.innerText||0));
  document.getElementById('grand').innerText=t.toFixed(2);
}

function askDelete(btn){
  deleteTarget=btn;
  document.getElementById('deleteModal').style.display='flex';
}
function closeDelete(){
  document.getElementById('deleteModal').style.display='none';
}
function confirmDelete(){
  const tr=deleteTarget.closest('tr');
  tr.nextElementSibling.remove();
  tr.remove();
  closeDelete();
  renumber(); recalcGrand(); saveMonth();
}

function renumber(){
  document.querySelectorAll('.no').forEach((n,i)=>n.innerText=i+1);
}

function saveMonth(){
  if(!monthInput.value) return;
  const data=[];
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    if(!tr.classList.contains('sub-row')){
      data.push({main:tr.innerHTML,sub:tr.nextElementSibling.innerHTML});
    }
  });
  localStorage.setItem('PO_'+monthInput.value,JSON.stringify(data));
}

function loadMonth(){
  const raw=localStorage.getItem('PO_'+monthInput.value);
  tbody.innerHTML='';
  if(!raw){addRow();return;}
  JSON.parse(raw).forEach(d=>{
    const m=document.createElement('tr'); m.innerHTML=d.main;
    const s=document.createElement('tr'); s.className='sub-row'; s.innerHTML=d.sub;
    tbody.append(m,s);
  });
  recalcGrand();
}

function copyWithPrompt(){
  document.getElementById('copyModal').style.display='flex';
  document.getElementById('copyTo').value=monthInput.value;
}
function closeCopy(){
  document.getElementById('copyModal').style.display='none';
}
function confirmCopy(){
  const from=document.getElementById('copyFrom').value;
  const to=document.getElementById('copyTo').value;
  const f=new Date(from+'-01');
  const t=new Date(to+'-01');
  f.setMonth(f.getMonth()+1);
  if(f.getTime()!==t.getTime()) return alert('‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
  const raw=localStorage.getItem('PO_'+from);
  if(!raw) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
  localStorage.setItem('PO_'+to,raw);
  closeCopy(); loadMonth();
}

function printPDF(){ window.print(); }

addRow();

</script>
</body>
</html>
